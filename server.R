library(shiny)
library(ggplot2)
library(tidyverse)
library(lubridate)
library(shinyjs)
library(here)
library(patchwork)

# function to calculate the slope parameter values for the graph 
calc_weights <- function(inputs, means, weights) {
  colSums(t(inputs + means) * weights) * c(1, 1/10, 1/1000, 1/100000, 1/10000000)
}

# function to calculate postdictions
postdict <-  function(.xx, weights) {
  weights()["i"] +
  weights()["s"] * (.xx-64) +
  weights()["q"] * (.xx-64)^2 +
  weights()["c"] * (.xx-64)^3 +
  weights()["p4"]* (.xx-64)^4 
  
 }
 
 # Core graph 
 coreplot <-  function(ymax){
   ggplot(data.frame(x = 0:180), aes(x)) +
     #lockdown period - 7th July to 26th October
     geom_rect(aes(xmin =  90, 
                   xmax = 180, 
                   ymin = -Inf, ymax = Inf), 
               fill = "grey", alpha = 0.1) +
     coord_cartesian(xlim = c(0, 180), ylim = c(0, ymax)) +
     theme_classic() +
     scale_color_manual(name = "Group",
                        values = c("Non-Victoria" = "Gold",
                                   "Victoria" = "DarkBlue")
     ) +
     scale_x_continuous(breaks = c(0, 30, 60, 90, 120, 150, 180),
                        labels = as.character(lubridate::dmy("8th April, 2020") + 0:180)[(c(0, 30, 60, 90, 120, 150, 180)+1)]
     ) +
     theme(line = element_line(size = 1.5),
           text = element_text(size = 16),
           panel.grid.major.y = element_line(colour = "grey80", size = .3),
           # Force 
           panel.background = element_rect(fill = NA),
           panel.ontop = TRUE) +
     annotate("text", x = mean(c(90, 180)), y = ymax, hjust = 0.5,
              label = "Melbourne lockdown", colour = "white", 
              fontface = "bold") + 
     labs(x = "Date", color = "Legend")
 } 

# Core server functionality -----------------------------------------------
server <- function(input, output) {
  
  # Reset button controls
  # observeEvent(input$reset, {
  #   reset("sidebar")
  # })
  
  # Recieve inputs from the UI ------------------------------------------
  # First value must be 1 (intercept) followed by
  # the inputs in the order they appear in the model weights table
  inputs <- reactive({
    c(1, 
      as.numeric(input$pgender), 
      input$page,
      as.numeric(input$cgender),
      input$cage,
      input$childno,
      as.numeric(input$nopartner),
      as.numeric(input$lote),
      as.numeric(input$educ),
      as.numeric(input$depr), 
      as.numeric(input$city), 
      input$introvert,
      as.numeric(input$chroncond),
      as.numeric(input$mentalcond),
      as.numeric(input$adhdasd),
      input$covidpsy, 
      input$covidrisk,
      input$media,
      as.numeric(input$child_home),
      as.numeric(input$renting),
      input$outdoorsize,
      input$homesatisfy,
      input$bedrooms,
      input$plonely, # UCLALS
      input$clonely,
      input$alcohol,
      input$conflict #Argue V
      )
  })
  
  # Contain  pre-modelled parameter weights -----------------------------
  # use the datapasta Add-in, paste table as tribble (excluding row labels)
  
  # Parent outcomes

  nv_d_mean <- tibble::tribble(~mean,  0, 0.78, 0.184,  0.489, 0.146,  0.053, 
                               0.099,  0.028, 0.082,  -0.062,  0.298, 0.045,
                               0.361, 0.424,  0.151, -0.026, -0.005, 0.03, 0.82,
                               0.315,  0.023, -0.01,  0.03,  -0.022,  0.022,
                               0.014,  -0.054)
                                
  nv_depr <-  tibble::tribble(
         ~i,     ~s,     ~q,     ~c,    ~p4,
      6.208, -0.023,  0.262, -0.511,  0.286,
     -0.819, -0.187,  0.099,  0.389, -0.292,
      0.149,  0.107, -0.175, -0.191,  0.198,
      0.533,  0.179, -0.124, -0.132,  0.099,
     -0.113, -0.051,  0.129,  0.165, -0.148,
      0.192, -0.036,   0.08,  0.206, -0.267,
     -0.321, -0.155, -0.026,  0.331, -0.186,
     -2.237, -0.382,  0.741,  1.246, -1.383,
      2.342,   0.31, -0.405, -0.337,  0.573,
      0.794,  0.024,  0.173, -0.021, -0.149,
     -0.184, -0.155,   0.14,  0.389, -0.347,
      0.723, -0.011,  -0.08,  0.147,  -0.05,
      0.342,  0.008, -0.043, -0.232,  0.186,
      2.496,  0.011,  0.216,  0.285, -0.459,
       0.69, -0.105, -0.495,   0.03,  0.512,
      0.684,  0.057, -0.007, -0.022,  0.019,
      0.629, -0.087,  0.094,  0.169, -0.147,
      0.175, -0.014,  0.167,   0.09, -0.222,
      0.188,  0.007,  0.118,  0.062, -0.148,
      1.332,  0.033,  0.032,  0.104, -0.041,
     -0.562,  -0.01,  0.069, -0.011, -0.039,
      -0.45, -0.024, -0.071, -0.032,  0.145,
     -0.009, -0.064,  0.112,  0.313, -0.342,
      2.415, -0.069, -0.142, -0.106,  0.344,
      0.701, -0.047,  0.059, -0.046,  0.041,
      0.317, -0.053,  0.093,  0.141, -0.176,
      0.428,   0.12, -0.023,  -0.22,  0.102
     )

  v_d_mean <-   tibble::tribble(~mean,  0, 0.854,  -0.052,  0.498, -0.105, 
                                -0.047, 0.111,  0.046, 0.08, 0.001,  0.29,  
                                -0.053,  0.319, 0.408,  0.13,  -0.01, 0.01, 
                                -0.001, 0.88, 0.275,  -0.026,  0.016, -0.027, 
                                -0.008, -0.027, 0.002,  0.013)
  
  
  v_depr <- tibble::tribble(
         ~i,     ~s,     ~q,     ~c,    ~p4,
      9.127,  0.403,  0.081, -0.957,  0.573,
     -0.884, -0.238,  0.828,  0.884, -1.243,
     -0.273, -0.055,  0.082,  0.287, -0.264,
     -0.675, -0.115,   0.12,  0.254, -0.205,
      0.305,  0.041, -0.081, -0.222,  0.263,
      0.418, -0.075,    0.1,  0.351, -0.342,
     -1.385, -0.233,  0.417,  0.943, -1.189,
     -0.621,  0.118, -0.439, -1.146,  1.571,
      0.022,  0.013,  0.064, -0.398,  0.472,
      0.501,  0.027,  -0.11, -0.293,  0.355,
     -0.611, -0.196,  0.199,  0.372, -0.373,
      0.351,  0.016, -0.074, -0.148,   0.17,
      0.328, -0.059, -0.001,  0.251, -0.225,
      2.144,  0.049,  0.107, -0.088,  -0.11,
     -0.164, -0.231, -0.184,  0.803, -0.439,
      0.518,  0.073, -0.144, -0.285,  0.369,
      0.498, -0.074,  0.257,  0.194, -0.383,
     -0.577, -0.035,  0.255,  0.124, -0.292,
     -0.266, -0.011, -0.047,  0.034, -0.018,
      0.528, -0.019,   0.02,  0.261, -0.278,
     -0.058,  0.049, -0.312, -0.394,  0.607,
     -0.879, -0.002,  0.073, -0.097,  0.025,
      0.248, -0.029,  0.056, -0.003,  0.053,
      3.174, -0.024,  0.034,  0.116,  -0.05,
      0.371,   0.06,  0.128, -0.162,  0.007,
      0.096,  0.009,   0.05, -0.076, -0.027,
      0.876,  -0.07,  0.073,  0.274, -0.298
     )

  

  nv_anx_mean <- tibble::tribble(~mean,  0, 0.78, 0.184, 0.489, 0.146, 0.052, 0.099, 0.028, 0.083, -0.063, 0.298, 0.044, 0.361, 0.425, 0.151, -0.025, -0.006, 0.031, 0.821, 0.316, 0.02, -0.01, 0.031, -0.019, 0.023, 0.016, -0.055)
  
  nv_anx <- tibble::tribble(
                   ~i,     ~s,     ~q,     ~c,    ~p4,
                2.743,  0.177,  0.196, -0.503,   0.19,
               -0.026, -0.074,  0.097,  0.081, -0.076,
               -0.618, -0.056,  0.029,   0.33, -0.265,
                0.154,   0.07, -0.201,  -0.11,  0.206,
                 0.33,   0.01, -0.009, -0.162,  0.167,
                0.317,  0.023, -0.026,  0.014, -0.044,
                0.908, -0.103,  0.018,  0.507, -0.392,
               -0.616, -0.003,  0.213,  0.058, -0.063,
                2.711,  0.481, -0.462, -1.065,  0.947,
                0.761,  0.068,  0.074, -0.163,  0.035,
               -0.275, -0.239,  0.192,  0.621, -0.492,
                0.302,  0.049,  0.038,  0.006, -0.066,
                0.299,  0.024,  -0.09, -0.211,  0.226,
                1.625,  0.002,  0.106,  0.022, -0.129,
                0.726, -0.005, -0.302,  0.004,    0.3,
                0.981,  0.021,  0.002, -0.156,  0.144,
                0.418, -0.093,    0.1,  0.289, -0.258,
                -0.09, -0.008,  0.117, -0.003, -0.094,
                0.064, -0.047,  0.003, -0.058,  0.032,
                1.066,  0.007,  -0.03,  0.122, -0.041,
               -0.247,  0.021,   0.04, -0.081,  0.034,
                 -0.1, -0.002,   0.02, -0.037,  0.038,
               -0.037,      0, -0.059,  0.036, -0.004,
                1.019, -0.063, -0.004,  0.051,  0.071,
                0.324,  0.031, -0.037, -0.207,  0.206,
                0.158, -0.029,  0.106,  0.018, -0.081,
                0.159,  0.083, -0.026, -0.148,  0.056
               )

  v_anx_mean <-    tibble::tribble(~mean,  0, 0.854, -0.053, 0.498, -0.104, -0.045, 0.113, 0.045, 0.08, 0, 0.29, -0.049, 0.319, 0.407, 0.129, -0.009, 0.01, -0.001, 0.88, 0.275, -0.026, 0.016, -0.026, -0.01, -0.022, -0.002, 0.014)
  
  v_anx <-  tibble::tribble(
                  ~i,     ~s,     ~q,     ~c,    ~p4,
               4.083,  0.004,  0.355, -0.034, -0.126,
                0.32, -0.071,   0.37,  0.232, -0.518,
              -0.553, -0.037,   0.08,  0.182, -0.218,
               -0.11,   0.07, -0.041, -0.128,  0.026,
               0.294, -0.045,  -0.01,  0.036, -0.003,
               0.153,  0.069,  0.198,  0.049,  -0.25,
              -1.194, -0.056,  0.039,  0.183, -0.227,
              -0.445, -0.157,  0.341,  0.144, -0.123,
               0.137,  0.224,   -0.5, -0.942,  1.273,
               0.769,  0.015, -0.146, -0.212,  0.321,
              -0.058, -0.003,  0.053,  0.009,  -0.08,
                0.46,  0.067, -0.154, -0.232,  0.266,
                0.38,  0.015,  0.285,  0.188, -0.424,
               1.435,  0.065,  0.188, -0.082, -0.217,
              -0.027, -0.034, -0.079,  0.274,  -0.17,
               0.503,  0.067,  0.061, -0.276,  0.157,
                 0.3,  0.035,  0.028, -0.115,  0.063,
               0.111,   0.01,  0.096, -0.026, -0.026,
              -0.182,  0.036, -0.511, -0.273,  0.658,
              -0.008,  0.248,  0.046,  -0.36,  0.115,
              -0.161,  0.011, -0.128,  -0.18,  0.256,
              -0.795,  0.059,  0.114, -0.184,  0.057,
               0.231,  0.008,  0.035,  0.049, -0.029,
               1.237, -0.016,   0.16,  0.147, -0.196,
               0.449,   0.02,  0.075, -0.068,  0.014,
               0.092,  0.026,  0.025, -0.095,  0.038,
               0.361, -0.058,  0.069,  0.209, -0.211
              )


  nv_stress_mean <-  tibble::tribble(~mean,  0, 0.78, 0.184, 0.489, 0.147, 0.05, 0.099, 0.028, 0.082, -0.061, 0.298, 0.043, 0.362, 0.425, 0.15, -0.026, -0.006, 0.03, 0.819, 0.315, 0.02, -0.01, 0.032, -0.02, 0.023, 0.015, -0.053)
  
  nv_stress <-  tibble::tribble(
                      ~i,     ~s,     ~q,     ~c,    ~p4,
                   9.437, -0.086,  0.474, -0.635,  0.273,
                   0.726, -0.044, -0.041,  0.051, -0.039,
                  -0.269,  0.049, -0.159,    0.1,  0.014,
                   0.691,  0.159, -0.212, -0.187,   0.23,
                  -0.829,  0.005,  0.209, -0.123, -0.027,
                   0.713, -0.045,  0.084,  0.231, -0.328,
                  -0.182,  0.032,  0.166, -0.174, -0.105,
                    -2.4,  0.043,  0.622,  0.486, -0.833,
                   1.376,  0.242, -0.811, -0.212,  0.813,
                   0.361,  0.101,  0.187, -0.195, -0.058,
                   0.149, -0.142,   -0.1,  0.316, -0.001,
                   0.511,   0.02, -0.113,  0.078,  0.036,
                   0.528,   0.04, -0.358, -0.401,  0.624,
                   2.565, -0.204,  0.327,  0.769, -0.815,
                   0.626, -0.074, -0.048,  0.492,  -0.31,
                   1.417,  0.058, -0.082, -0.311,   0.32,
                   0.058, -0.202,   0.22,  0.507, -0.441,
                  -0.077,  0.011,  0.182, -0.076, -0.119,
                   0.082, -0.121,  0.296,  0.252, -0.482,
                   1.396,  0.023,  0.009,  0.184, -0.136,
                    -0.3,  0.056,  0.061, -0.151,   0.04,
                  -0.447, -0.113,  0.125,  0.177, -0.173,
                   0.282,  0.015, -0.021,  0.002, -0.023,
                   1.522, -0.063,  -0.08,  0.003,  0.153,
                    0.71, -0.005, -0.002, -0.119,  0.117,
                   0.549, -0.007,  0.032, -0.097,  0.078,
                   1.186,  0.149, -0.059, -0.332,  0.217
                  )

  v_stress_mean <-  tibble::tribble(~mean,  0, 0.854, -0.053, 0.497, -0.104, -0.044, 0.112, 0.046, 0.08, 0.001, 0.289, -0.051, 0.319, 0.406, 0.129, -0.008, 0.013, -0.003, 0.88, 0.274, -0.026, 0.014, -0.03, -0.007, -0.019, 0.001, 0.016)
                                    
  v_stress <- tibble::tribble(
                    ~i,     ~s,     ~q,     ~c,    ~p4,
                13.337, -0.138,  0.017, -0.163,  0.246,
                 0.396,  0.011,  0.769,  0.355, -0.982,
                -0.451, -0.173,  0.207,  0.734, -0.682,
                -0.513,  0.021, -0.002,   0.19,  -0.25,
                -0.772,   0.05, -0.085, -0.305,  0.244,
                 0.797, -0.104,  0.285,  0.434, -0.556,
                -1.893,  -0.21,  0.185,  0.809, -0.833,
                -1.264,  0.066,  0.167, -0.464,  0.232,
                -0.524,  0.054, -0.066,  -0.66,  0.667,
                 0.629,  0.033, -0.145, -0.219,  0.324,
                -0.188, -0.058,  0.057,  0.107, -0.094,
                 0.012,  0.043,  0.025, -0.107,  0.006,
                 0.336,  0.042,  0.139, -0.121,  0.054,
                 2.023,  0.122,  0.371, -0.181, -0.371,
                 0.645, -0.352, -0.218,  1.123, -0.711,
                 0.472,  0.089,  0.108, -0.286,  0.123,
                 0.569, -0.003,  0.046, -0.141,  0.071,
                -0.219,      0,   0.09, -0.011,  -0.04,
                 -1.44, -0.166,   0.45,  0.442, -0.618,
                 0.171,  0.286, -0.358, -0.731,  0.715,
                -0.012,  0.076, -0.219, -0.383,  0.337,
                -1.013,   0.07,  0.082, -0.358,  0.233,
                 0.368, -0.065,  0.005,  0.063, -0.004,
                 2.122,  -0.07,  0.105,   0.19, -0.095,
                 1.075,   0.04, -0.008, -0.073,  0.088,
                 0.035,  0.011,  0.042, -0.134,  0.097,
                 1.391,  -0.07, -0.116,  0.235,  -0.08
                )

  
  # Child outcomes
  
  nv_cdep_mean <- tibble::tribble(~mean,  0, 0.773, 0.273, 0.483, 0.293, 0.134, 0.102, 0.026, 0.083, -0.074, 0.3, 0.043, 0.36, 0.425, 0.163, -0.021, -0.001, 0.026, 0.826, 0.314, 0.013, 0, -0.014, -0.034, 0.009, 0.039, -0.05)
                                  

  nv_cdep <- tibble::tribble(
                   ~i,     ~s,     ~q,     ~c,    ~p4,
                3.133, -0.241,  0.451,  0.417, -0.665,
                0.038, -0.147,  0.021,  0.284, -0.122,
                0.131,  0.051, -0.103, -0.126,   0.15,
                0.472,  0.006, -0.117,  0.114,  0.041,
                0.204, -0.047,  0.065,  0.149, -0.142,
                0.123,  0.069, -0.097, -0.129,  0.158,
                0.019,   0.04,  0.447,  0.177,   -0.5,
               -0.838, -0.063,  0.156,   0.32, -0.298,
               -0.122, -0.128,  0.152,  0.712,  -0.57,
                0.218,  0.003, -0.044, -0.027,  0.073,
                0.242,  0.108, -0.065, -0.205,  0.197,
                0.125,  0.045, -0.028, -0.126,  0.126,
                0.321, -0.024, -0.047,  0.073,  0.005,
                0.648,  0.075, -0.042, -0.214,   0.17,
                1.825, -0.056, -0.156,  0.335,  -0.18,
                0.301,  0.027, -0.025, -0.018,  0.025,
                 0.13,  0.015,  0.033, -0.037, -0.048,
                0.167,  0.038, -0.084, -0.133,   0.14,
                -0.58,   0.03, -0.033,  -0.21,  0.188,
                0.832, -0.002, -0.134,  0.034,  0.029,
               -0.238,  0.034, -0.022, -0.119,  0.107,
               -0.257, -0.078,  0.159,  0.188, -0.267,
                 0.16,  0.093, -0.114, -0.293,  0.311,
                0.274, -0.084,  0.033,  0.212, -0.172,
                1.488,  -0.05,  0.107, -0.113,  0.044,
               -0.186,  -0.08,  0.094,  0.212, -0.222,
                0.351,  0.014, -0.022,  0.015,  0.018
               )

    
    v_cdep_mean <-  tibble::tribble(~mean,  0, 0.854, 0.05, 0.501, 0.084, 0.085, 0.121, 0.043, 0.081, -0.007, 0.305, -0.033, 0.325, 0.408, 0.145, 0.003, -0.024, 0.01, 0.881, 0.252, -0.012, 0.045, -0.061, 0.007, -0.016, 0.018, 0.041)
                                    
  
  v_cdep <- tibble::tribble(
                  ~i,     ~s,     ~q,     ~c,    ~p4,
               3.411, -0.247,  0.459,  0.776, -0.884,
               0.767,  0.048,  0.129, -0.006, -0.117,
              -0.273,  0.031, -0.118, -0.209,  0.261,
              -0.034, -0.032,  0.147,  0.193, -0.303,
               0.746,  0.036,  -0.15,  0.027,  0.064,
               0.089, -0.111,  0.172,  0.282, -0.324,
              -0.135, -0.096,  0.375,  0.265, -0.548,
              -0.461, -0.053, -0.102, -0.148,  0.318,
              -0.509, -0.197,  0.324,  0.301, -0.387,
               0.482,  0.053, -0.104, -0.088,  0.099,
               0.145, -0.159, -0.009,  0.253, -0.125,
               0.293, -0.023, -0.124,  0.077,   0.03,
               0.094,  -0.03,   0.08,  0.104, -0.133,
               0.647, -0.004, -0.015,  0.126,  -0.09,
               2.108, -0.026, -0.369,  0.157,   0.19,
               0.032,  -0.02,  0.017,  0.038, -0.044,
               0.257,  0.008,  0.097,  0.038, -0.152,
               0.087, -0.042,  0.077,  0.181, -0.185,
              -0.247,  0.009,  -0.06, -0.157,  0.184,
               0.225,   0.05, -0.002, -0.178,  0.159,
               -0.06, -0.006, -0.048,  -0.04,  0.089,
              -0.576,  -0.02,  0.056,  -0.03, -0.009,
              -0.159, -0.044,  0.089,  0.049, -0.086,
                0.36, -0.022, -0.037,  0.002,  0.071,
               1.217, -0.018,  0.145, -0.174,  0.063,
              -0.068,   0.04, -0.013, -0.107,  0.094,
               0.619, -0.071,   0.04,  0.234, -0.195
              )

  
  nv_canx_mean <- tibble::tribble(~mean,  0, 0.773, 0.273, 0.483, 0.293, 0.135, 0.102, 0.026, 0.083, -0.074, 0.301, 0.043, 0.36, 0.425, 0.163, -0.021, 0, 0.026, 0.824, 0.316, 0.01, -0.001, -0.013, -0.035, 0.011, 0.039, -0.048)
  
  nv_canx <- tibble::tribble(
    ~i,     ~s,     ~q,     ~c,    ~p4,
    2.122,  -0.06,  0.217,  0.139, -0.267,
    0.224,  0.003, -0.038, -0.017,  0.053,
    0.091,  0.003, -0.038,  0.003,  0.034,
    0.36,  0.008, -0.087,  0.023,   0.04,
    -0.37,  0.011,  0.037, -0.037,      0,
    -0.058,  0.045, -0.035, -0.067,  0.066,
    0.352,  0.031,  0.106, -0.027, -0.081,
    -0.654,   -0.2,  0.161,  0.385,  -0.27,
    -0.128, -0.013, -0.108, -0.019,  0.138,
    0.084, -0.013, -0.007,  0.013,  0.011,
    -0.185, -0.013,  0.075,  0.046, -0.075,
    0.14,  0.007, -0.019, -0.011,  0.012,
    0.154, -0.014, -0.007, -0.031,  0.053,
    0.377, -0.013,  0.033,      0, -0.016,
    0.625,  0.055, -0.194, -0.157,    0.3,
    0.196,  0.017,  0.001,  0.003, -0.011,
    -0.003, -0.002,  0.029,  0.002, -0.038,
    -0.014,  0.003, -0.013, -0.013,  0.025,
    -0.219, -0.008, -0.036, -0.057,  0.072,
    0.403,  0.034,   -0.1, -0.014,  0.052,
    -0.035,  0.026, -0.024, -0.092,  0.084,
    -0.078, -0.014,  0.019,  0.019, -0.029,
    0.053,  0.043,  0.003, -0.061,  0.029,
    0.031, -0.041,  0.039,  0.114, -0.113,
    0.496,  -0.03,  0.069,  0.032, -0.063,
    0.007, -0.015, -0.025,  0.033,  0.002,
    0.281,   0.03, -0.061, -0.044,  0.071
  )
     
  v_canx_mean <-  tibble::tribble(~mean,  0, 0.853, 0.049, 0.499, 0.08, 0.086, 0.12, 0.044, 0.081, -0.008, 0.305, -0.031, 0.326, 0.41, 0.146, 0.008, -0.024, 0.008, 0.88, 0.252, -0.012, 0.045, -0.065, 0.006, -0.02, 0.016, 0.035)
  
  v_canx <-  tibble::tribble(
    ~i,     ~s,     ~q,     ~c,    ~p4,
    1.522, -0.096,  0.145,  0.141, -0.173,
    0.594,  0.092, -0.035, -0.226,  0.159,
    0.116, -0.028,  0.005,   0.06,  -0.05,
    0.284, -0.003,  0.015,  0.022, -0.034,
    -0.298,  0.034, -0.033, -0.081,  0.073,
    -0.047, -0.041,  0.026,  0.067,  -0.05,
    0.242,      0, -0.044, -0.071,  0.103,
    -0.371, -0.034, -0.002,  0.118, -0.161,
    -0.041, -0.102,   0.01,  0.079,  0.036,
    0.227,   0.01, -0.047, -0.017,  0.023,
    0.194,  -0.02,  0.066,  0.094, -0.127,
    0.011, -0.017,  0.011,  0.038, -0.035,
    0.011,  0.025,  0.036, -0.033, -0.016,
    0.516,  0.039,  0.022, -0.058,  0.014,
    0.385, -0.028, -0.001,  0.079, -0.047,
    0.124, -0.036,  0.036,  0.097, -0.082,
    0.061, -0.007,  0.028,  0.009, -0.031,
    0.112, -0.003, -0.021, -0.002,  0.029,
    0.284, -0.015, -0.043,  0.086, -0.044,
    0.114,  0.052,  0.022, -0.103,  0.049,
    0.006,  0.005, -0.003, -0.008, -0.012,
    -0.129,   0.01,  0.026, -0.031,  0.006,
    -0.014, -0.015,  -0.01, -0.004,  0.026,
    0.098, -0.012,  0.019,  0.007, -0.002,
    0.526,  0.003,  0.031, -0.043,  0.015,
    -0.22,  0.004,  0.012,  0.017, -0.018,
    0.236, -0.007, -0.028,  0.052, -0.016
  )
  
  
  # calculates weights given input parameters------
  
  
  depr_nv <-  reactive({
    calc_weights(inputs(), nv_d_mean, nv_depr)
  })
  
  depr_v <-  reactive({
    calc_weights(inputs(), v_d_mean, v_depr)
  })
  
  anx_nv <-  reactive({
    calc_weights(inputs(), nv_anx_mean, nv_anx)
  })
  
  anx_v <-  reactive({
    calc_weights(inputs(), v_anx_mean, v_anx)
  })
  
  stress_nv <-  reactive({
    calc_weights(inputs(), nv_stress_mean, nv_stress)
  })
  
  stress_v <-  reactive({
    calc_weights(inputs(), v_stress_mean, v_stress)
  })
  
  cdep_nv <-  reactive({
    calc_weights(inputs(), nv_cdep_mean, nv_cdep)
  })
  
  cdep_v <-  reactive({
    calc_weights(inputs(), v_cdep_mean, v_cdep)
  })
  
  canx_nv <-  reactive({
    calc_weights(inputs(), nv_canx_mean, nv_canx)
  })
  
  canx_v <-  reactive({
    calc_weights(inputs(), v_canx_mean, v_canx)
  })
  # Generates dignostic outputs for display------
  # output$inputs <- renderTable((inputs()))
  # output$v_params <- renderTable(t(depr_v()))
  # output$nv_params <- renderTable(t(depr_nv()))
  
  
  # Reference plot of daily cases -------------------------------------------
  
  refdat <- readRDS(here::here("data", "refdata.RDS"))
  refplot <- refdat %>% ggplot(aes(date, positives, colour = state_abbrev)) +
    # lockdown period - 7th July to 26th October
    geom_rect(aes(xmin = date(dmy("8th april, 2020") + 90), 
                  xmax = date(dmy("8th April, 2020") + 180), 
                  ymin = -Inf, ymax = Inf),
              fill = "grey", alpha = 0.2,  data = tibble(x= 0:180), inherit.aes = FALSE) +
    geom_line() +
    theme_classic() +
    theme(line = element_line(size = 1.5),
          text = element_text(size = 16),
          panel.grid.major.y = element_line(colour = "grey80", size = .3)) + 
    labs(Title = "Daily COVID-19 positive tests",  y = "Positive tests", x = "Date", colour = "State")
  
  
  
  # Generate and composite plots per page -----------------------------------
  
  # x =  time  0 == April 8th
  output$deprPlot <- renderPlot({
    
    p1 <-  coreplot(ymax = 18)  +
      # Model
      geom_function(fun = postdict, args = list(weights = depr_nv),
        aes(color = "Non-Victoria")
      ) +
      geom_function(fun = postdict, args = list(weights = depr_v),
        aes(color = "Victoria")
      ) + 
      labs(title = "Modelled Parent Depression over time", y = "Parent depression")
    
    
    (p1 / refplot) + plot_layout(heights = c(2, 1))
    
    
    
  }, height = 600)
  
  
  
  output$anxPlot <- renderPlot({
    
    p2 <-  coreplot(ymax = 10)  +
      # Model
      geom_function(fun = postdict, args = list(weights = anx_nv),
                    aes(color = "Non-Victoria")
      ) +
      geom_function(fun = postdict, args = list(weights = anx_v),
                    aes(color = "Victoria")
      ) + 
      labs(title = "Modelled Parent Anxiety over time", y = "Parent anxiety")
    
    
    (p2 / refplot) + plot_layout(heights = c(2, 1))
    
    
    
  }, height = 600)
  
  output$stressPlot <- renderPlot({
    
    p3 <-  coreplot(ymax = 20)  +
      # Model
      geom_function(fun = postdict, args = list(weights = stress_nv),
                    aes(color = "Non-Victoria")
      ) +
      geom_function(fun = postdict, args = list(weights = stress_v),
                    aes(color = "Victoria")
      ) + 
      labs(title = "Modelled Parent Stress over time", y = "Parent stress")
    
    
    (p3 / refplot) + plot_layout(heights = c(2, 1))
    
    
    
  }, height = 600)
  
  output$cdepPlot <- renderPlot({
    
    p4 <-  coreplot(ymax = 10)  +
      # Model
      geom_function(fun = postdict, args = list(weights = cdep_nv),
                    aes(color = "Non-Victoria")
      ) +
      geom_function(fun = postdict, args = list(weights = cdep_v),
                    aes(color = "Victoria")
      ) + 
      labs(title = "Modelled Child Depression over time", y = "Child depression")
    
    
    (p4 / refplot) + plot_layout(heights = c(2, 1))
    
    
    
  }, height = 600)
  
  output$canxPlot <- renderPlot({
    
    p5 <-  coreplot(ymax = 7)  +
      # Model
      geom_function(fun = postdict, args = list(weights = canx_nv),
                    aes(color = "Non-Victoria")
      ) +
      geom_function(fun = postdict, args = list(weights = canx_v),
                    aes(color = "Victoria")
      ) + 
      labs(title = "Modelled Child Depression over time", y = "Child depression")
    
    
    (p5 / refplot) + plot_layout(heights = c(2, 1))
    
    
    
  }, height = 600)
  
  
}



